@model ITIExaminationSystemMVC.Models.StudentExamViewModel

@{
    ViewData["Title"] = "Take Exam - " + Model.CourseName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<style>
    .question-card { display: none; }
    .question-card.active { display: block; animation: fadeIn 0.3s; }
    .nav-btn { width: 40px; height: 40px; margin: 2px; font-weight: bold; }
    .nav-btn.answered { background-color: #198754; color: white; border-color: #198754; }
    .nav-btn.current { border: 2px solid #0d6efd; box-shadow: 0 0 5px rgba(13,110,253,0.5); }
    .nav-btn.flagged { background-color: #ffc107; color: black; border-color: #ffc107; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .timer-box { font-family: 'Courier New', monospace; font-size: 1.5rem; font-weight: bold; }
</style>

<div class="container mt-4">
    <form id="examForm" asp-action="SubmitExam" method="post">
        <input type="hidden" asp-for="ExamId" />
        <input type="hidden" asp-for="CourseId" />
        <input type="hidden" asp-for="CourseName" />

        <div class="row">
            <!-- Sidebar / Question Palette -->
            <div class="col-lg-3 order-lg-2 mb-4">
                <div class="card shadow-sm sticky-top" style="top: 20px; z-index: 100;">
                    <div class="card-header bg-light text-center">
                        <label class="small text-muted text-uppercase fw-bold">Time Remaining</label>
                        <div id="timer" class="timer-box text-danger">00:00:00</div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title text-center mb-3">Question Palette</h6>
                        <div class="d-flex flex-wrap justify-content-center" id="questionPalette">
                            @for (int i = 0; i < Model.Questions.Count; i++)
                            {
                                <button type="button" class="btn btn-outline-secondary nav-btn" 
                                        data-index="@i" onclick="goToQuestion(@i)">
                                    @(i + 1)
                                </button>
                            }
                        </div>
                        <div class="mt-3 small text-center">
                            <span class="badge bg-success">Answered</span>
                            <span class="badge bg-warning text-dark">Flagged</span>
                            <span class="badge border text-dark">Unvisited</span>
                        </div>
                        <hr />
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to finish the exam?');">
                                <i class="bi bi-check-circle me-2"></i>Submit Exam
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Question Area -->
            <div class="col-lg-9 order-lg-1">
                @for (int i = 0; i < Model.Questions.Count; i++)
                {
                    <div class="card question-card shadow-sm mb-4" id="q_card_@i">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <h5 class="mb-0 text-primary">Question @(i + 1) of @Model.Questions.Count</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleFlag(@i)">
                                    <i class="bi bi-flag-fill"></i> Flag
                                </button>
                                <span class="badge bg-secondary ms-2">@Model.Questions[i].Mark Marks</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <p class="lead fw-normal mb-4">@Model.Questions[i].Body</p>

                            @if (Model.Questions[i].Type == "TF")
                            {
                                <div class="form-check p-3 border rounded mb-2">
                                    <input class="form-check-input" type="radio" 
                                           name="UserAnswers[@Model.Questions[i].Id]" value="True" 
                                           id="q_@(i)_t" onchange="markAnswered(@i)">
                                    <label class="form-check-label" for="q_@(i)_t">True</label>
                                </div>
                                <div class="form-check p-3 border rounded mb-2">
                                    <input class="form-check-input" type="radio" 
                                           name="UserAnswers[@Model.Questions[i].Id]" value="False" 
                                           id="q_@(i)_f" onchange="markAnswered(@i)">
                                    <label class="form-check-label" for="q_@(i)_f">False</label>
                                </div>
                            }
                            else
                            {
                                @for (int j = 0; j < Model.Questions[i].Choices.Count; j++)
                                {
                                    var choice = Model.Questions[i].Choices[j];
                                    <div class="form-check p-3 border rounded mb-2">
                                        <input class="form-check-input" type="radio" 
                                               name="UserAnswers[@Model.Questions[i].Id]" value="@choice" 
                                               id="q_@(i)_c_@j" onchange="markAnswered(@i)">
                                        <label class="form-check-label" for="q_@(i)_c_@j">@choice</label>
                                    </div>
                                }
                            }
                        </div>
                        <div class="card-footer bg-light d-flex justify-content-between py-3">
                            <button type="button" class="btn btn-outline-secondary px-4" 
                                    onclick="prevQuestion()" @(i == 0 ? "disabled" : "")>Previous</button>
                            
                            @if (i < Model.Questions.Count - 1)
                            {
                                <button type="button" class="btn btn-primary px-4" onclick="nextQuestion()">Next</button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </form>
</div>

<script>
    let currentIndex = 0;
    const totalQuestions = @Model.Questions.Count;
    // Ensure integer
    const durationMinutes = @(Model.DurationMinutes);
    let timeRemaining = durationMinutes * 60; // seconds

    function updateTimer() {
        const hours = Math.floor(timeRemaining / 3600);
        const minutes = Math.floor((timeRemaining % 3600) / 60);
        const seconds = timeRemaining % 60;

        const timerEl = document.getElementById("timer");
        if(timerEl) {
            timerEl.innerText = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
             if (timeRemaining <= 0) {
                // Stop timer
                timeRemaining = 0;
                // Avoid multiple alerts
                // alert("Time is up! Submitting your exam now.");
                document.getElementById("examForm").submit();
            } else {
                timeRemaining--;
                if(timeRemaining < 300) { 
                    timerEl.classList.add("text-danger");
                }
            }
        }
    }

    // Start timer
    setInterval(updateTimer, 1000);

    function showQuestion(index) {
        // Hide all active
        document.querySelectorAll('.question-card.active').forEach(el => el.classList.remove('active'));
        
        // Show target
        const target = document.getElementById(`q_card_${index}`);
        if(target) target.classList.add('active');
        
        // Update Palette
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('current'));
        const navBtn = document.querySelector(`.nav-btn[data-index="${index}"]`);
        if(navBtn) navBtn.classList.add('current');
        
        currentIndex = index;
    }

    function nextQuestion() {
        if (currentIndex < totalQuestions - 1) {
            showQuestion(currentIndex + 1);
        }
    }

    function prevQuestion() {
        if (currentIndex > 0) {
            showQuestion(currentIndex - 1);
        }
    }

    function goToQuestion(index) {
        showQuestion(index);
    }

    function markAnswered(index) {
        const btn = document.querySelector(`.nav-btn[data-index="${index}"]`);
        if(btn) btn.classList.add('answered');
    }

    function toggleFlag(index) {
        const btn = document.querySelector(`.nav-btn[data-index="${index}"]`);
        if(btn) btn.classList.toggle('flagged');
    }

    document.addEventListener("DOMContentLoaded", () => {
        showQuestion(0);
    });
</script>
